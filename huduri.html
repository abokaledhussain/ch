<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“‹ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø¯ÙˆØ§Ù… - Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#1f5fa6; --primary-700:#174b83; --accent:#0ea5e9;
  --bg:#f6f8fc; --card:#fff; --muted:#64748b; --ok:#16a34a; --warn:#ef4444; --border:#e5e7eb;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);font-family:"Cairo",system-ui,-apple-system,sans-serif;color:#0f172a}
.container{max-width:1200px;margin:26px auto;padding:16px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
header img{height:52px;width:52px;object-fit:contain;border-radius:10px;background:#fff;border:1px solid var(--border)}
header h1{margin:0;font-size:22px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:12px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
button,.btn{
  appearance:none;border:1px solid var(--primary);background:var(--primary);color:#fff;
  padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700
}
button:hover{background:var(--primary-700);border-color:var(--primary-700)}
.btn-ghost{background:#fff;color:#0f172a;border-color:var(--border)}
.btn-ghost:hover{background:#f8fafc}
.btn-ok{background:var(--ok);border-color:var(--ok)}
.btn-warn{background:var(--warn);border-color:var(--warn)}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:230px}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input[type="text"],input[type="date"],input[type="number"],textarea,select{
  width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none
}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:10px;border-bottom:1px solid var(--border);background:#fff;vertical-align:middle}
th{position:sticky;top:0;background:#f8fafc;font-size:13px;color:#334155;z-index:1}
tr:hover td{background:#f9fafb}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.hidden{display:none !important}

/* Actions icons */
.icon-btn{background:#fff;border:1px solid var(--border);padding:6px 10px;border-radius:10px;cursor:pointer}
.icon-btn:hover{background:#f8fafc}
.actions{display:flex;gap:6px}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
.modal{position:fixed;inset:0;display:none;z-index:60;align-items:center;justify-content:center;padding:16px}
.modal .panel{max-width:95vw;width:900px;background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden}
.modal .panel header{padding:14px 16px;border-bottom:1px solid var(--border)}
.modal .panel .body{padding:16px;max-height:70vh;overflow:auto}
.modal .panel footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-start}
.modal.show,.modal-backdrop.show{display:flex}

/* Print */
@media print{
  .toolbar, .no-print, .icon-btn, .actions, .btn, .modal-backdrop{display:none !important}
  body{background:#fff}
  .card{border:none;box-shadow:none}
  .print-header{display:block !important;margin-bottom:10px}
}
.print-header{display:none}
.print-headline{font-weight:700}

/* Badges */
.tag{font-size:12px;border:1px dashed var(--border);padding:2px 8px;border-radius:999px;background:#fafafa;color:#475569}
</style>
</head>
<body>
<div class="container">

  <!-- Header with dynamic logo/name -->
  <header>
    <img id="schoolLogo" alt="Ø´Ø¹Ø§Ø±" src="" onerror="this.style.display='none'">
    <div>
      <h1 id="schoolTitle">ğŸ“‹ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø¯ÙˆØ§Ù… - Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰</h1>
      <div class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± â€“ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="card">
    <div class="toolbar">
      <button id="btnSettings" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (ØªØ±ÙˆÙŠØ³Ø©/Ø´Ø¹Ø§Ø±/Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨/Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù‚Ø³Ø§Ù…)">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>

      <button id="btnBrowse" class="btn-ghost" title="Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†">ğŸ“‚ Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>

      <button id="btnStatsRange" class="btn-ghost" title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø®Ù„Ø§Ù„ ÙØªØ±Ø©">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø®Ù„Ø§Ù„ ÙØªØ±Ø©</button>

      <label class="btn-ghost" title="Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ù…Ù„Ù Ø­Ø¶ÙˆØ±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯">
        ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ù:
        <input type="date" id="fileDate" style="width:auto;margin-inline-start:8px">
      </label>

      <label class="btn-ghost" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel Ù…Ù† Ø­Ø¶ÙˆØ±ÙŠ/Ù…Ù†Ø¸Ù…" style="display:flex;align-items:center;gap:8px">
        ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none">
      </label>

      <button id="btnExportJSON" class="btn-ghost" title="ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© JSON">ğŸ’¾ ØªØµØ¯ÙŠØ± JSON</button>
      <label class="btn-ghost" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© JSON" style="display:flex;align-items:center;gap:8px">
        â¤´ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
        <input type="file" id="jsonInput" accept=".json" style="display:none">
      </label>

      <button id="btnClear" class="btn-warn" title="Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    </div>
    <p class="small" style="margin-top:8px">
      ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ù…Ù„Ù Ù…Ù†Ø¸Ù… (<span class="tag">Ø§Ù„Ø§Ø³Ù…</span>ØŒ <span class="tag">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</span>ØŒ <span class="tag">Ø§Ù„Ø¬ÙˆØ§Ù„</span>ØŒ <span class="tag">Ø§Ù„ØªØ®ØµØµ</span>ØŒ ...)ØŒ
      Ø£Ùˆ Ù…Ù„Ù Ø­Ø¶ÙˆØ±ÙŠ Ø®Ø§Ù… ÙˆØ³Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ <span class="tag">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (10 Ø£Ø±Ù‚Ø§Ù…)</span> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
    </p>
  </div>

  <!-- Add/Update Employee -->
  <div class="card" id="sectionAdd">
    <h3>â• Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¸Ù</h3>
    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="empName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
      </div>
      <div class="col">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
        <input type="text" id="empID" class="mono" placeholder="1XXXXXXXXX">
      </div>
      <div class="col">
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
        <input type="text" id="empPhone" class="mono" placeholder="05XXXXXXXX">
      </div>
      <div class="col">
        <label>Ø§Ù„ØªØ®ØµØµ</label>
        <input type="text" id="empSpecialty" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª">
      </div>
      <div class="col" style="display:flex;align-items:flex-end">
        <button id="btnAddEmp">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
      </div>
    </div>
  </div>

  <!-- Employees Table (hidden until browse) -->
  <div id="sectionTable" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
      <h3 style="margin:0">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
      <input id="q" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„ØªØ®ØµØµ" style="max-width:320px">
    </div>
    <div class="table-wrap">
      <table id="grid">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
            <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
            <th>Ø§Ù„ØªØ®ØµØµ</th>
            <th class="no-print">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <footer class="small center no-print" style="margin-top:16px">Ø¨Ø±Ù…Ø¬Ø© Ø­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±ÙŠØ§Ù†ÙŠ ğŸ’¥ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³Ø¹</footer>
</div>

<!-- ===== Modals ===== -->
<div class="modal-backdrop" id="backdrop"></div>

<!-- Settings Modal -->
<div class="modal" id="modalSettings" aria-hidden="true">
  <div class="panel">
    <header><h3 style="margin:0">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3></header>
    <div class="body">
      <div class="row">
        <div class="col">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input type="text" id="setSchoolName" placeholder="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰">
        </div>
        <div class="col">
          <label>Ø±ÙØ¹/ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±</label>
          <input type="file" id="setLogo" accept="image/*">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Ø³Ø·Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© 1</label>
          <input type="text" id="setHdr1" placeholder="Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©">
        </div>
        <div class="col">
          <label>Ø³Ø·Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© 2</label>
          <input type="text" id="setHdr2" placeholder="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…">
        </div>
        <div class="col">
          <label>Ø³Ø·Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© 3</label>
          <input type="text" id="setHdr3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
        </div>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">

      <h4 style="margin:6px 0 10px">ğŸ’¬ Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨</h4>
      <div class="small" style="margin-bottom:8px">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <span class="tag">{Ø§Ù„Ø§Ø³Ù…}</span> <span class="tag">{Ø§Ù„ØªØ§Ø±ÙŠØ®}</span> <span class="tag">{Ø§Ù„Ù…Ø¯Ø±Ø³Ø©}</span></div>
      <div class="row">
        <div class="col">
          <label>Ù‚Ø§Ù„Ø¨ ØªÙ†Ø¨ÙŠÙ‡</label>
          <textarea id="tplNotify" rows="4" placeholder="Ø£Ø®ÙŠ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±ØŒ Ù†ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±ÙƒÙ… Ø¨Ø®ØµÙˆØµ {Ø§Ù„Ø§Ø³Ù…} Ø¨ØªØ§Ø±ÙŠØ® {Ø§Ù„ØªØ§Ø±ÙŠØ®}."></textarea>
        </div>
        <div class="col">
          <label>Ù‚Ø§Ù„Ø¨ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©</label>
          <textarea id="tplGeneral" rows="4" placeholder="Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ù‡Ø°Ø§ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù… Ù…Ù† {Ø§Ù„Ù…Ø¯Ø±Ø³Ø©} Ø¨Ø®ØµÙˆØµ {Ø§Ù„Ø§Ø³Ù…} Ø¨ØªØ§Ø±ÙŠØ® {Ø§Ù„ØªØ§Ø±ÙŠØ®}."></textarea>
        </div>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">

      <h4 style="margin:6px 0 10px">ğŸ‘ï¸â€ğŸ—¨ï¸ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù…</h4>
      <div class="row">
        <label class="col" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="showAdd" checked> Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… "Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¸Ù"
        </label>
        <label class="col" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="showBrowse" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†"
        </label>
        <label class="col" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="showStats" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø®Ù„Ø§Ù„ ÙØªØ±Ø©"
        </label>
      </div>
    </div>
    <footer>
      <button class="btn-ok" id="btnSaveSettings">Ø­ÙØ¸</button>
      <button class="btn-ghost" id="btnCloseSettings">Ø¥ØºÙ„Ø§Ù‚</button>
    </footer>
  </div>
</div>

<!-- Employee Stats Modal -->
<div class="modal" id="modalEmpStats" aria-hidden="true">
  <div class="panel">
    <header>
      <h3 id="empStatsTitle" style="margin:0">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h3>
    </header>
    <div class="body">
      <div class="print-header" id="empPrintHeader"></div>
      <div id="empStatsTableWrap" class="table-wrap">
        <table id="empStatsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ)</th>
              <th>Ø­Ø§Ø¶Ø±</th>
              <th>ØºÙŠØ§Ø¨</th>
              <th>ØªØ£Ø®ÙŠØ±</th>
              <th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th>
              <th>Ø¥Ø¬Ø§Ø²Ø§Øª</th>
              <th>Ø§Ø³ØªØ¦Ø°Ø§Ù†Ø§Øª</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <footer>
      <button class="btn-ghost" id="btnEmpExport">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn-ghost" id="btnEmpPrint">ğŸ“„ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="btnEmpClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </footer>
  </div>
</div>

<!-- Range Stats Modal -->
<div class="modal" id="modalRange" aria-hidden="true">
  <div class="panel">
    <header><h3 style="margin:0">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø®Ù„Ø§Ù„ ÙØªØ±Ø©</h3></header>
    <div class="body">
      <div class="row" style="margin-bottom:10px">
        <div class="col">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="rangeFrom">
        </div>
        <div class="col">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="rangeTo">
        </div>
        <div class="col" style="display:flex;align-items:flex-end">
          <button id="btnRunRange" class="btn">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        </div>
      </div>

      <div class="print-header" id="rangePrintHeader"></div>

      <div class="table-wrap">
        <table id="rangeTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
              <th>Ø­Ø¶ÙˆØ±</th>
              <th>ØºÙŠØ§Ø¨</th>
              <th>ØªØ£Ø®ÙŠØ±</th>
              <th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th>
              <th>Ø¥Ø¬Ø§Ø²Ø§Øª</th>
              <th>Ø§Ø³ØªØ¦Ø°Ø§Ù†Ø§Øª</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <footer>
      <button class="btn-ghost" id="btnRangeExport">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn-ghost" id="btnRangePrint">ğŸ“„ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="btnRangeClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </footer>
  </div>
</div>

<script>
/* ================== Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ================== */
const KEY_DB = "attendance.db.v1";
const KEY_SETTINGS = "attendance.settings.v1";

/* ================== Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ================== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
function load(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
function formatHijri(dateISO){
  try{
    const d = new Date(dateISO);
    return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(d);
  }catch{ return ""; }
}
function blobToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

/* ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ================== */
let SETTINGS = load(KEY_SETTINGS, {
  schoolName: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰",
  logoDataURL: "",
  header1: "Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
  header2: "ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…",
  header3: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰",
  showAdd:true, showBrowse:true, showStats:true,
  tplNotify: "Ø£Ø®ÙŠ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±ØŒ Ù†ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±ÙƒÙ… Ø¨Ø´Ø£Ù† {Ø§Ù„Ø§Ø³Ù…} Ø¨ØªØ§Ø±ÙŠØ® {Ø§Ù„ØªØ§Ø±ÙŠØ®}.\nÙ…Ø¹ ØªØ­ÙŠØ§Øª {Ø§Ù„Ù…Ø¯Ø±Ø³Ø©}",
  tplGeneral: "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù… Ù…Ù† {Ø§Ù„Ù…Ø¯Ø±Ø³Ø©} Ø¨Ø®ØµÙˆØµ {Ø§Ù„Ø§Ø³Ù…} Ø¨ØªØ§Ø±ÙŠØ® {Ø§Ù„ØªØ§Ø±ÙŠØ®}."
});
applySettingsToUI();

/* ================== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ================== */
let DB = load(KEY_DB, {}); // {id: {id,name,phone,specialty, records:[{date,hijri,present,absent,late,early,leave,excuse,note}] }}

/* ================== Ø¹Ù†Ø§ØµØ± ================== */
const el = {
  schoolLogo: $('#schoolLogo'),
  schoolTitle: $('#schoolTitle'),

  // inputs
  empName: $('#empName'), empID: $('#empID'), empPhone: $('#empPhone'), empSpecialty: $('#empSpecialty'),
  btnAddEmp: $('#btnAddEmp'),

  excelInput: $('#excelInput'), jsonInput: $('#jsonInput'),
  btnExportJSON: $('#btnExportJSON'), btnClear: $('#btnClear'),
  btnBrowse: $('#btnBrowse'), btnStatsRange: $('#btnStatsRange'),
  fileDate: $('#fileDate'),

  // table
  sectionTable: $('#sectionTable'), q: $('#q'), gridBody: $('#grid tbody'),

  // settings
  btnSettings: $('#btnSettings'), modalSettings: $('#modalSettings'),
  setSchoolName: $('#setSchoolName'), setLogo: $('#setLogo'),
  setHdr1: $('#setHdr1'), setHdr2: $('#setHdr2'), setHdr3: $('#setHdr3'),
  showAdd: $('#showAdd'), showBrowse: $('#showBrowse'), showStats: $('#showStats'),
  tplNotify: $('#tplNotify'), tplGeneral: $('#tplGeneral'),
  btnSaveSettings: $('#btnSaveSettings'), btnCloseSettings: $('#btnCloseSettings'),

  // emp stats modal
  modalEmpStats: $('#modalEmpStats'), empStatsTitle: $('#empStatsTitle'),
  empStatsTable: $('#empStatsTable'), empStatsTbody: $('#empStatsTable tbody'),
  btnEmpExport: $('#btnEmpExport'), btnEmpPrint: $('#btnEmpPrint'), btnEmpClose: $('#btnEmpClose'),
  empPrintHeader: $('#empPrintHeader'),

  // range modal
  modalRange: $('#modalRange'), rangeFrom: $('#rangeFrom'), rangeTo: $('#rangeTo'),
  btnRunRange: $('#btnRunRange'), rangeTable: $('#rangeTable'), rangeTbody: $('#rangeTable tbody'),
  btnRangeExport: $('#btnRangeExport'), btnRangePrint: $('#btnRangePrint'), btnRangeClose: $('#btnRangeClose'),
  rangePrintHeader: $('#rangePrintHeader'),

  // others
  backdrop: $('#backdrop'),
  sectionAdd: $('#sectionAdd')
};
el.fileDate.value = todayISO();

/* ================== ÙˆØ¸Ø§Ø¦Ù Ø£Ø³Ø§Ø³ÙŠØ© ================== */
function upsertEmployee(id, name, phone, specialty){
  const k = String(id||"").trim(); if(!k) return;
  if(!DB[k]) DB[k] = { id:k, name:"", phone:"", specialty:"", records:[] };
  if(name!==undefined && name!=="") DB[k].name = name.trim();
  if(phone!==undefined && phone!=="") DB[k].phone = phone.trim();
  if(specialty!==undefined && specialty!=="") DB[k].specialty = specialty.trim();
  save(KEY_DB, DB);
}

function addRecordForEmployee(id, rec){
  if(!DB[id]) return;
  DB[id].records.push(rec);
  save(KEY_DB, DB);
}

function renderEmployees(){
  const q = el.q.value.trim();
  const arr = Object.values(DB);
  const filtered = arr.filter(e=>{
    if(!q) return true;
    const hay = `${e.name} ${e.id} ${e.phone} ${e.specialty}`.toLowerCase();
    return hay.includes(q.toLowerCase());
  }).sort((a,b)=> (a.name||"").localeCompare(b.name||"", 'ar'));

  el.gridBody.innerHTML = "";
  filtered.forEach((e,i)=>{
    const tr = document.createElement('tr');
    const telHref = e.phone ? `tel:${e.phone}` : '#';
    const waMsg = buildWhatsAppMessage('notify', e.name);
    const waHref = e.phone ? `https://wa.me/${e.phone.replace(/\D/g,'')}?text=${encodeURIComponent(waMsg)}` : '#';

    tr.innerHTML = `
      <td class="mono">${i+1}</td>
      <td>${e.name||""}</td>
      <td class="mono">${e.id||""}</td>
      <td class="mono">${e.phone||""}</td>
      <td>${e.specialty||""}</td>
      <td class="actions no-print">
        <button class="icon-btn" title="ØªØ¹Ø¯ÙŠÙ„" data-act="edit" data-id="${e.id}">âœï¸</button>
        <button class="icon-btn" title="Ø­Ø°Ù" data-act="del" data-id="${e.id}">ğŸ—‘ï¸</button>
        <a class="icon-btn" title="Ø§ØªØµØ§Ù„" href="${telHref}" ${e.phone?'':'onclick="return false"'}>ğŸ“</a>
        <a class="icon-btn" title="ÙˆØ§ØªØ³Ø§Ø¨ (Ù‚Ø§Ù„Ø¨ ØªÙ†Ø¨ÙŠÙ‡)" href="${waHref}" target="_blank" ${e.phone?'':'onclick="alert(\'Ø£Ø¶Ù Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ù‹Ø§\');return false"'}>ğŸ’¬</a>
        <button class="icon-btn" title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù" data-act="stats" data-id="${e.id}">ğŸ“Š</button>
      </td>
    `;
    el.gridBody.appendChild(tr);
  });
}

/* ================== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© ================== */
$('#btnAddEmp').onclick = ()=>{
  const name = el.empName.value.trim();
  const id = el.empID.value.trim();
  const phone = el.empPhone.value.trim();
  const specialty = el.empSpecialty.value.trim();
  if(!id){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©"); return; }
  upsertEmployee(id, name, phone, specialty);
  el.empName.value = ""; el.empID.value = ""; el.empPhone.value = ""; el.empSpecialty.value = "";
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù.");
};

el.btnBrowse.onclick = ()=>{
  el.sectionTable.classList.remove('hidden');
  renderEmployees();
};
el.q.addEventListener('input', ()=>renderEmployees());

/* Ø­Ø°Ù/ØªØ¹Ø¯ÙŠÙ„/Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙˆØ¸Ù */
el.gridBody.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('[data-act]'); if(!btn) return;
  const act = btn.dataset.act; const id = btn.dataset.id; if(!id) return;

  if(act==='del'){
    if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ")){
      delete DB[id]; save(KEY_DB, DB); renderEmployees();
    }
  }else if(act==='edit'){
    const emp = DB[id];
    const name = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:", emp.name||"") ?? emp.name;
    const phone = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ§Ù„:", emp.phone||"") ?? emp.phone;
    const sp = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ®ØµØµ:", emp.specialty||"") ?? emp.specialty;
    upsertEmployee(id, name, phone, sp); renderEmployees();
  }else if(act==='stats'){
    openEmpStats(id);
  }
});

/* ================== Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± ================== */
$('#btnExportJSON').onclick = ()=>{
  const blob = new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = "attendance_backup.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$('label[title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© JSON"]').addEventListener('click', ()=> el.jsonInput.click());
el.jsonInput.onchange = async (e)=>{
  const f = e.target.files?.[0]; e.target.value=""; if(!f) return;
  try{
    const data = JSON.parse(await f.text());
    if(typeof data==='object' && !Array.isArray(data)){ DB = data; save(KEY_DB, DB); renderEmployees(); alert("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹."); }
    else alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
  }catch{ alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© JSON."); }
};
el.btnClear.onclick = ()=>{
  if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")){
    DB = {}; save(KEY_DB, DB); renderEmployees(); alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­.");
  }
};

/* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel Ù…Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ù */
$('label[title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel Ù…Ù† Ø­Ø¶ÙˆØ±ÙŠ/Ù…Ù†Ø¸Ù…"]').addEventListener('click', ()=> el.excelInput.click());
el.excelInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; e.target.value=""; if(!file) return;
  const dateISO = el.fileDate.value || todayISO();
  const hijri = formatHijri(dateISO);

  const reader = new FileReader();
  reader.onload = (ev)=>{
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const first = wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[first], {defval:""});
    if(!rows.length){ alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"); return; }

    const headers = Object.keys(rows[0]).map(h=>String(h).trim());
    const isOrganized = headers.includes("Ø§Ù„Ø§Ø³Ù…") && headers.includes("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©");
    const idRegex = /(\d{10})/;

    rows.forEach(r=>{
      let name = String(r["Ø§Ù„Ø§Ø³Ù…"]||"").trim();
      let id = String(r["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©"]||"").trim();
      let phone = String(r["Ø§Ù„Ø¬ÙˆØ§Ù„"]||r["Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„"]||"").trim();
      let specialty = String(r["Ø§Ù„ØªØ®ØµØµ"]||"").trim();

      if(!isOrganized){
        if(!id){
          for(const k of Object.keys(r)){
            const v = String(r[k]??"");
            const m = v.match(idRegex);
            if(m){ id = m[1]; if(!name) name = v.replace(m[1],"").trim(); break; }
          }
        }
      }
      if(!id) return;

      // Ø£Ù†Ø´Ø¦/Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…ÙˆØ¸Ù
      upsertEmployee(id, name, phone, specialty);

      // ÙƒÙˆÙ‘Ù† Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 0 Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯)
      const toNum = (x)=> Number(String(x).replace(/[^\d.-]/g,""))||0;
      const rec = {
        date: dateISO, hijri,
        present: toNum(r["Ø­Ø§Ø¶Ø±"]),
        absent:  toNum(r["ØºÙŠØ§Ø¨"]),
        late:    toNum(r["ØªØ£Ø®ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±"]||r["ØªØ£Ø®ÙŠØ±"]),
        early:   toNum(r["Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±"]||r["Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±"]),
        leave:   toNum(r["Ø§Ù„Ø§Ø¬Ø§Ø²Ø§Øª"]||r["Ø¥Ø¬Ø§Ø²Ø§Øª"]),
        excuse:  toNum(r["Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†Ø§Øª"]||r["Ø§Ø³ØªØ¦Ø°Ø§Ù†Ø§Øª"]),
        note: String(r["Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]||r["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").trim()
      };
      addRecordForEmployee(id, rec);
    });

    alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ù.");
    if(!el.sectionTable.classList.contains('hidden')) renderEmployees();
  };
  reader.readAsArrayBuffer(file);
});

/* ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ================== */
$('#btnSettings').onclick = ()=> openModal(el.modalSettings);
$('#btnCloseSettings').onclick = ()=> closeModal(el.modalSettings);
$('#btnSaveSettings').onclick = async ()=>{
  SETTINGS.schoolName = el.setSchoolName.value.trim() || SETTINGS.schoolName;
  SETTINGS.header1 = el.setHdr1.value.trim() || SETTINGS.header1;
  SETTINGS.header2 = el.setHdr2.value.trim() || SETTINGS.header2;
  SETTINGS.header3 = el.setHdr3.value.trim() || SETTINGS.header3;
  SETTINGS.showAdd = el.showAdd.checked;
  SETTINGS.showBrowse = el.showBrowse.checked;
  SETTINGS.showStats = el.showStats.checked;
  SETTINGS.tplNotify = el.tplNotify.value || SETTINGS.tplNotify;
  SETTINGS.tplGeneral = el.tplGeneral.value || SETTINGS.tplGeneral;

  if(el.setLogo.files && el.setLogo.files[0]){
    SETTINGS.logoDataURL = await blobToDataURL(el.setLogo.files[0]);
  }

  save(KEY_SETTINGS, SETTINGS);
  applySettingsToUI();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
  closeModal(el.modalSettings);
};
function applySettingsToUI(){
  // Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©
  el.schoolTitle.textContent = `ğŸ“‹ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø¯ÙˆØ§Ù… - ${SETTINGS.schoolName}`;
  if(SETTINGS.logoDataURL){ el.schoolLogo.src = SETTINGS.logoDataURL; el.schoolLogo.style.display='block'; }

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…/Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  el.sectionAdd.style.display = SETTINGS.showAdd ? '' : 'none';
  $('#btnBrowse').style.display = SETTINGS.showBrowse ? '' : 'none';
  $('#btnStatsRange').style.display = SETTINGS.showStats ? '' : 'none';

  // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  el.setSchoolName.value = SETTINGS.schoolName;
  el.setHdr1.value = SETTINGS.header1;
  el.setHdr2.value = SETTINGS.header2;
  el.setHdr3.value = SETTINGS.header3;
  el.showAdd.checked = SETTINGS.showAdd;
  el.showBrowse.checked = SETTINGS.showBrowse;
  el.showStats.checked = SETTINGS.showStats;
  el.tplNotify.value = SETTINGS.tplNotify;
  el.tplGeneral.value = SETTINGS.tplGeneral;
}

/* ================== ÙˆØ§ØªØ³Ø§Ø¨ ================== */
function buildWhatsAppMessage(kind, employeeName){
  const base = kind==='notify' ? SETTINGS.tplNotify : SETTINGS.tplGeneral;
  const date = new Date().toISOString().slice(0,10);
  return base
    .replaceAll("{Ø§Ù„Ø§Ø³Ù…}", employeeName||"")
    .replaceAll("{Ø§Ù„ØªØ§Ø±ÙŠØ®}", date)
    .replaceAll("{Ø§Ù„Ù…Ø¯Ø±Ø³Ø©}", SETTINGS.schoolName||"");
}

/* ================== Ù†ÙˆØ§ÙØ° Ù…Ù†Ø¨Ø«Ù‚Ø© ================== */
function openModal(m){ el.backdrop.classList.add('show'); m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
function closeModal(m){ el.backdrop.classList.remove('show'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
el.backdrop.onclick = ()=>{
  [el.modalSettings, el.modalEmpStats, el.modalRange].forEach(m=> m.classList.remove('show'));
  el.backdrop.classList.remove('show');
};

/* ====== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙˆØ¸Ù ====== */
function openEmpStats(id){
  const emp = DB[id]; if(!emp){ alert("Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
  el.empStatsTitle.textContent = `ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù â€” ${emp.name} (${emp.id})`;

  // Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  el.empPrintHeader.innerHTML = `
    <div class="print-headline">${SETTINGS.header1||""}</div>
    <div class="print-headline">${SETTINGS.header2||""}</div>
    <div class="print-headline">${SETTINGS.header3||SETTINGS.schoolName||""}</div>
    <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${todayISO()} â€” Ù‡Ø¬Ø±ÙŠ: ${formatHijri(todayISO())}</div>
    <hr>
    <div>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù: ${emp.name||""} â€” Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: ${emp.id||""} â€” Ø§Ù„Ø¬ÙˆØ§Ù„: ${emp.phone||""} â€” Ø§Ù„ØªØ®ØµØµ: ${emp.specialty||""}</div>
  `;

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ø¬Ù„
  el.empStatsTbody.innerHTML = "";
  emp.records
    .sort((a,b)=> a.date.localeCompare(b.date))
    .forEach((r,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${idx+1}</td>
        <td class="mono">${r.date||""}</td>
        <td>${r.hijri||""}</td>
        <td class="mono">${r.present||0}</td>
        <td class="mono">${r.absent||0}</td>
        <td class="mono">${r.late||0}</td>
        <td class="mono">${r.early||0}</td>
        <td class="mono">${r.leave||0}</td>
        <td class="mono">${r.excuse||0}</td>
        <td>${r.note||""}</td>
      `;
      el.empStatsTbody.appendChild(tr);
    });

  // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  el.modalEmpStats.dataset.empId = id;

  openModal(el.modalEmpStats);
}
el.btnEmpClose.onclick = ()=> closeModal(el.modalEmpStats);

// ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙˆØ¸Ù
el.btnEmpExport.onclick = ()=>{
  const id = el.modalEmpStats.dataset.empId;
  const emp = DB[id]; if(!emp) return;
  const tbl = el.empStatsTable;
  const ws = XLSX.utils.table_to_sheet(tbl);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "EmployeeStats");
  XLSX.writeFile(wb, `stats_${emp.name}_${id}.xlsx`);
};
el.btnEmpPrint.onclick = ()=> window.print();

/* ====== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØªØ±Ø© ====== */
$('#btnStatsRange').onclick = ()=> openModal(el.modalRange);
el.btnRangeClose.onclick = ()=> closeModal(el.modalRange);

$('#btnRunRange').onclick = ()=>{
  const from = el.rangeFrom.value || "0001-01-01";
  const to = el.rangeTo.value || "9999-12-31";
  const rows = [];

  Object.values(DB).forEach(emp=>{
    const recs = emp.records.filter(r=> r.date>=from && r.date<=to);
    const sum = (k)=> recs.reduce((a,c)=> a + Number(c[k]||0), 0);
    rows.push({
      emp, days: recs.length,
      present:sum('present'), absent:sum('absent'), late:sum('late'), early:sum('early'),
      leave:sum('leave'), excuse:sum('excuse')
    });
  });

  // Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  el.rangePrintHeader.innerHTML = `
    <div class="print-headline">${SETTINGS.header1||""}</div>
    <div class="print-headline">${SETTINGS.header2||""}</div>
    <div class="print-headline">${SETTINGS.header3||SETTINGS.schoolName||""}</div>
    <div>Ø§Ù„ÙØªØ±Ø©: Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to} â€” Ù‡Ø¬Ø±ÙŠ Ø§Ù„ÙŠÙˆÙ…: ${formatHijri(todayISO())}</div>
    <hr>
  `;

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
  el.rangeTbody.innerHTML = "";
  rows.sort((a,b)=> (a.emp.name||"").localeCompare(b.emp.name||"", 'ar'))
      .forEach((r,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${idx+1}</td>
          <td>${r.emp.name||""}</td>
          <td class="mono">${r.emp.id||""}</td>
          <td class="mono">${r.present}</td>
          <td class="mono">${r.absent}</td>
          <td class="mono">${r.late}</td>
          <td class="mono">${r.early}</td>
          <td class="mono">${r.leave}</td>
          <td class="mono">${r.excuse}</td>
          <td class="mono">${r.days}</td>
        `;
        el.rangeTbody.appendChild(tr);
      });
};

el.btnRangeExport.onclick = ()=>{
  const ws = XLSX.utils.table_to_sheet(el.rangeTable);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "RangeStats");
  XLSX.writeFile(wb, `stats_range.xlsx`);
};
el.btnRangePrint.onclick = ()=> window.print();

/* ====== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ====== */
function init(){
  applySettingsToUI();
  // ÙØªØ­ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
  // (ØªÙ… Ø¶Ø¨Ø·Ù‡ Ø£Ø¹Ù„Ø§Ù‡)
}
init();
</script>
</body>
</html>